---
phase: 01-pipeline-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/db/index.ts
  - services/contract/pipeline/types.ts
  - services/contract/pipeline/dedup.ts
  - services/contract/pipeline/watcher.ts
  - services/contract/pipeline/index.ts
autonomous: true

must_haves:
  truths:
    - "Dropping a PDF into the watched folder triggers a callback function"
    - "Same PDF filename is not processed twice"
    - "System handles graceful shutdown on SIGINT/SIGTERM"
    - "Non-PDF files are ignored"
  artifacts:
    - path: "services/contract/pipeline/watcher.ts"
      provides: "Chokidar file watcher with PDF filtering"
      min_lines: 40
    - path: "services/contract/pipeline/dedup.ts"
      provides: "SQLite-based deduplication functions"
      exports: ["isAlreadyProcessed", "markAsProcessed"]
    - path: "services/contract/pipeline/index.ts"
      provides: "Main pipeline entrypoint"
      exports: ["startPipeline", "stopPipeline"]
    - path: "lib/db/index.ts"
      provides: "processed_contracts table schema"
      contains: "CREATE TABLE IF NOT EXISTS processed_contracts"
  key_links:
    - from: "services/contract/pipeline/watcher.ts"
      to: "services/contract/pipeline/dedup.ts"
      via: "import { isAlreadyProcessed, markAsProcessed }"
      pattern: "isAlreadyProcessed|markAsProcessed"
    - from: "services/contract/pipeline/index.ts"
      to: "services/contract/pipeline/watcher.ts"
      via: "import { startWatcher, stopWatcher }"
      pattern: "startWatcher|stopWatcher"
---

<objective>
Implement the contract pipeline foundation: a folder watcher that detects new PDFs and triggers processing, with SQLite-based deduplication to prevent reprocessing.

Purpose: This is the entry point for the entire Contract Cascade system. Without reliable PDF detection, no downstream processing can occur.

Output: A working `services/contract/pipeline/` module that watches a configurable folder, detects new PDFs, deduplicates by filename, and calls a handler callback.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-pipeline-foundation/01-RESEARCH.md
@lib/db/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add processed_contracts table and chokidar dependency</name>
  <files>lib/db/index.ts, package.json</files>
  <action>
    1. Run `bun add chokidar` to install the file watcher dependency

    2. Add the processed_contracts table to lib/db/index.ts (after the monday_cache table):
    ```sql
    CREATE TABLE IF NOT EXISTS processed_contracts (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      filename TEXT NOT NULL UNIQUE,
      file_path TEXT NOT NULL,
      processed_at TEXT NOT NULL DEFAULT (datetime('now')),
      status TEXT NOT NULL DEFAULT 'pending'
    )
    ```

    3. Add index for filename lookups:
    ```sql
    CREATE INDEX IF NOT EXISTS idx_processed_contracts_filename ON processed_contracts(filename)
    ```

    Follow the existing pattern in lib/db/index.ts for table definitions (use db.run with template literal SQL).
  </action>
  <verify>
    - `bun run -e "import { db } from './lib/db'; console.log(db.query('SELECT name FROM sqlite_master WHERE type=\"table\" AND name=\"processed_contracts\"').get())"` returns the table name
    - `grep chokidar package.json` shows the dependency
  </verify>
  <done>
    - processed_contracts table exists in SQLite schema
    - chokidar is in package.json dependencies
  </done>
</task>

<task type="auto">
  <name>Task 2: Create pipeline types and deduplication module</name>
  <files>services/contract/pipeline/types.ts, services/contract/pipeline/dedup.ts</files>
  <action>
    1. Create services/contract/pipeline/types.ts with pipeline types:
    ```typescript
    export type ProcessingStatus = "pending" | "processing" | "completed" | "failed";

    export type ProcessedContract = {
      id: number;
      filename: string;
      filePath: string;
      processedAt: string;
      status: ProcessingStatus;
    };

    export type PipelineHandler = (filePath: string) => Promise<void>;
    ```

    2. Create services/contract/pipeline/dedup.ts with deduplication functions:
    - Import db from "@/lib/db"
    - Import path from "node:path" for basename extraction
    - isAlreadyProcessed(filePath: string): Promise<boolean> - checks if filename exists in processed_contracts
    - markAsProcessed(filePath: string, status?: ProcessingStatus): Promise<void> - inserts filename and path
    - Use synchronous Bun SQLite API (db.query().get() and db.run())
    - Functions can be sync since bun:sqlite is sync, but mark as async for future-proofing

    Pattern from research:
    ```typescript
    export function isAlreadyProcessed(filePath: string): boolean {
      const filename = path.basename(filePath);
      const row = db.query("SELECT 1 FROM processed_contracts WHERE filename = ?").get(filename);
      return row !== null;
    }
    ```
  </action>
  <verify>
    - `bun run -e "import { isAlreadyProcessed, markAsProcessed } from './services/contract/pipeline/dedup'"` runs without error
    - TypeScript compiles: `bunx tsc --noEmit services/contract/pipeline/types.ts services/contract/pipeline/dedup.ts`
  </verify>
  <done>
    - types.ts defines ProcessingStatus, ProcessedContract, PipelineHandler
    - dedup.ts exports isAlreadyProcessed and markAsProcessed
    - Functions interact correctly with SQLite
  </done>
</task>

<task type="auto">
  <name>Task 3: Create watcher and main pipeline entrypoint</name>
  <files>services/contract/pipeline/watcher.ts, services/contract/pipeline/index.ts</files>
  <action>
    1. Create services/contract/pipeline/watcher.ts:
    - Import chokidar (default import)
    - Import isAlreadyProcessed, markAsProcessed from "./dedup"
    - Import PipelineHandler from "./types"
    - Define WATCH_DIR from process.env.CONTRACT_WATCH_DIR ?? "./contracts"
    - Store watcher instance in module-level variable
    - startWatcher(onNewPdf: PipelineHandler): Promise<void>
      - Initialize chokidar.watch with options from research:
        - persistent: true
        - ignoreInitial: true (don't process existing files on startup)
        - awaitWriteFinish: { stabilityThreshold: 2000, pollInterval: 100 }
        - ignored: /(^|[\/\\])\../ (ignore dotfiles)
      - On "add" event: check if PDF, check dedup, mark processed, call handler
      - On "ready" event: log that watcher is ready
      - On "error" event: log error (don't crash)
    - stopWatcher(): Promise<void> - close watcher if exists

    2. Create services/contract/pipeline/index.ts:
    - Import startWatcher, stopWatcher from "./watcher"
    - Re-export types from "./types"
    - Export startPipeline and stopPipeline (wrapper functions)
    - Add graceful shutdown handlers for SIGINT and SIGTERM
    - Include a main() function for direct execution:
    ```typescript
    async function main() {
      await startPipeline(async (filePath) => {
        console.log(`[Pipeline] Processing: ${filePath}`);
        // Placeholder - future phases will add real processing
      });
      console.log("Pipeline running. Press Ctrl+C to stop.");
    }

    // Run if executed directly
    if (import.meta.main) {
      main();
    }
    ```

    Key implementation details from research:
    - Use async handler for watcher events
    - Check filePath.toLowerCase().endsWith(".pdf") before processing
    - Log file paths on detection
    - Handle errors in try/catch, log but don't crash
  </action>
  <verify>
    Test manually:
    1. Create test directory: `mkdir -p ./contracts`
    2. Start pipeline: `bun run services/contract/pipeline/index.ts &`
    3. Wait for "Pipeline running" message
    4. Drop a PDF: `touch ./contracts/test.pdf`
    5. Should see "[Pipeline] Processing: ./contracts/test.pdf"
    6. Drop same file again: should NOT see processing message (deduped)
    7. Drop non-PDF: `touch ./contracts/test.txt` - should be ignored
    8. Ctrl+C should show "Shutting down watcher..." and exit cleanly
  </verify>
  <done>
    - watcher.ts watches configured folder for new PDFs
    - index.ts provides startPipeline/stopPipeline exports
    - Duplicate files are not reprocessed
    - Non-PDF files are ignored
    - Graceful shutdown works
  </done>
</task>

</tasks>

<verification>
After all tasks complete, run end-to-end verification:

1. **Schema check:**
   ```bash
   bun run -e "import { db } from './lib/db'; const t = db.query('SELECT sql FROM sqlite_master WHERE name=\"processed_contracts\"').get(); console.log(t)"
   ```
   Should show CREATE TABLE statement.

2. **Dependency check:**
   ```bash
   bun pm ls | grep chokidar
   ```
   Should show chokidar version.

3. **Import check:**
   ```bash
   bun run -e "import { startPipeline, stopPipeline } from './services/contract/pipeline'; console.log('imports ok')"
   ```
   Should print "imports ok".

4. **Integration test:**
   ```bash
   # Start pipeline in background
   bun run services/contract/pipeline/index.ts &
   PID=$!
   sleep 2

   # Create test directory and file
   mkdir -p ./contracts
   touch ./contracts/integration-test.pdf
   sleep 3

   # Check logs for processing message
   # Kill pipeline
   kill $PID

   # Verify deduplication
   bun run -e "import { isAlreadyProcessed } from './services/contract/pipeline/dedup'; console.log(isAlreadyProcessed('./contracts/integration-test.pdf'))"
   # Should print "true"
   ```

5. **Lint check:**
   ```bash
   bunx ultracite check services/contract/pipeline/
   ```
   Should pass with no errors.
</verification>

<success_criteria>
Phase 1 requirements satisfied:

- [TRIG-01] System watches a folder for new PDF files
  - Verified by: watcher.ts using chokidar with PDF extension filter

- [TRIG-02] New PDF detection triggers processing pipeline
  - Verified by: onNewPdf callback invoked when PDF added

- [TRIG-03] Supports local folder (can add SharePoint later)
  - Verified by: WATCH_DIR configurable via environment variable
  - Architecture allows swapping watcher implementation in future

Additional:
- Deduplication prevents reprocessing same filename
- Graceful shutdown on SIGINT/SIGTERM
- Error handling prevents crashes on watcher errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-pipeline-foundation/01-01-SUMMARY.md` using the summary template.
</output>
