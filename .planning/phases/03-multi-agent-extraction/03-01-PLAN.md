---
phase: 03-multi-agent-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/contract/agents/types.ts
  - services/contract/agents/schemas/contract-info.ts
  - services/contract/agents/schemas/billing.ts
  - services/contract/agents/schemas/contacts.ts
  - services/contract/agents/schemas/sov.ts
  - services/contract/agents/schemas/insurance.ts
  - services/contract/agents/schemas/site-info.ts
  - services/contract/agents/schemas/red-flags.ts
  - services/contract/agents/storage.ts
  - services/contract/agents/mistral-client.ts
  - lib/db/index.ts
autonomous: true

must_haves:
  truths:
    - "All 7 extraction domains have Zod schemas with pageReferences fields"
    - "Agent results can be stored and retrieved from SQLite"
    - "Mistral client is configured for structured extraction"
  artifacts:
    - path: "services/contract/agents/types.ts"
      provides: "AgentName, AgentResult, ExtractionResults types"
    - path: "services/contract/agents/schemas/contract-info.ts"
      provides: "ContractInfoSchema with Zod"
      contains: "z.object"
    - path: "services/contract/agents/schemas/billing.ts"
      provides: "BillingSchema with Zod"
      contains: "z.object"
    - path: "services/contract/agents/schemas/contacts.ts"
      provides: "ContactsSchema with Zod"
      contains: "z.object"
    - path: "services/contract/agents/schemas/sov.ts"
      provides: "ScheduleOfValuesSchema with Zod"
      contains: "z.object"
    - path: "services/contract/agents/schemas/insurance.ts"
      provides: "InsuranceSchema with Zod"
      contains: "z.object"
    - path: "services/contract/agents/schemas/site-info.ts"
      provides: "SiteInfoSchema with Zod"
      contains: "z.object"
    - path: "services/contract/agents/schemas/red-flags.ts"
      provides: "RedFlagsSchema with Zod"
      contains: "z.object"
    - path: "services/contract/agents/storage.ts"
      provides: "storeAgentResult, getAgentResults functions"
      exports: ["storeAgentResult", "getAgentResults"]
    - path: "services/contract/agents/mistral-client.ts"
      provides: "createMistralClient function"
      exports: ["createMistralClient"]
    - path: "lib/db/index.ts"
      provides: "contract_extractions table"
      contains: "contract_extractions"
  key_links:
    - from: "services/contract/agents/storage.ts"
      to: "lib/db/index.ts"
      via: "db import"
      pattern: 'import.*db.*from.*"@/lib/db"'
    - from: "services/contract/agents/schemas/*.ts"
      to: "zod"
      via: "schema definition"
      pattern: 'import.*z.*from.*"zod"'
---

<objective>
Create the foundation for multi-agent extraction: Zod schemas for all 7 extraction domains, storage layer for agent results, and Mistral client configuration.

Purpose: Establish type-safe schemas that guide LLM extraction and storage infrastructure for results
Output: 7 Zod schemas, storage functions, Mistral client helper, contract_extractions table
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-multi-agent-extraction/03-RESEARCH.md
@services/contract/extraction/types.ts
@services/contract/extraction/storage.ts
@lib/db/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create types and all 7 Zod schemas</name>
  <files>
    services/contract/agents/types.ts
    services/contract/agents/schemas/contract-info.ts
    services/contract/agents/schemas/billing.ts
    services/contract/agents/schemas/contacts.ts
    services/contract/agents/schemas/sov.ts
    services/contract/agents/schemas/insurance.ts
    services/contract/agents/schemas/site-info.ts
    services/contract/agents/schemas/red-flags.ts
  </files>
  <action>
Create the types file and all 7 Zod schemas following the research patterns.

**types.ts:**
- AgentName union type: "contractInfo" | "billing" | "contacts" | "sov" | "insurance" | "siteInfo" | "redFlags"
- AgentResult generic type with: agentName, status ("success" | "error"), data?, error?, durationMs
- ExtractionResults type as Map<AgentName, AgentResult>

**Each schema file** must:
1. Import z from "zod"
2. Define the schema with `.describe()` annotations on EVERY field (guides LLM)
3. Include `pageReferences: z.array(z.number().int().positive()).describe("Page numbers where this information was found (1-indexed)")`
4. Export both the schema and inferred type using `z.infer`
5. Use `.nullable()` for optional fields, NOT `.optional()` (LLM should always return the field)

**Schema field requirements from RESEARCH.md:**

contract-info.ts (EXTR-01):
- contractType: enum ["LOI", "Subcontract", "Work Order", "Amendment", "Unknown"]
- contractDate: string nullable (YYYY-MM-DD)
- contractValue: number nullable (USD, no symbols)
- projectName: string
- projectAddress: string nullable
- startDate: string nullable (YYYY-MM-DD)
- endDate: string nullable (YYYY-MM-DD)
- pageReferences: array of positive integers

billing.ts (EXTR-02):
- retentionPercent: number nullable (without % symbol)
- billingPlatform: enum ["Textura", "Procore", "GCPay", "Premier", "Email", "Other", "Unknown"]
- billingWindow: string nullable
- billingContact: object { name, email, phone } nullable
- certifiedPayrollRequired: boolean
- certifiedPayrollType: enum ["Davis-Bacon", "HUD", "State Prevailing Wage", "None"]
- pageReferences

contacts.ts (EXTR-03):
- projectManager: object { name, phone, email } nullable
- superintendent: object { name, phone, email } nullable
- pageReferences

sov.ts (EXTR-04):
- sovIncluded: boolean
- lineItems: array of { itemNumber, description, amount } - amount nullable
- scopeSummary: array of strings
- pageReferences

insurance.ts (EXTR-05):
- glLimits: string nullable (e.g., "$1M per occurrence / $2M aggregate")
- umbrellaLimits: string nullable
- autoLimits: string nullable
- workersCompLimits: string nullable
- coiRequired: boolean
- additionalInsured: boolean
- waiverOfSubrogation: boolean
- primaryNonContributory: boolean
- bondingRequirements: string nullable
- pageReferences

site-info.ts (EXTR-06):
- siteAddress: string nullable
- siteHours: string nullable
- accessInstructions: string nullable
- safetyRequirements: array of strings
- pageReferences

red-flags.ts (EXTR-07):
- unusualTerms: array of { term, concern, pageRef }
- maintenanceLanguage: object { found, description, pageRef }
- tmLanguage: object { found, description, pageRef }
- vagueLanguage: array of { phrase, concern, pageRef }
- missingInfo: array of strings
- overallRiskLevel: enum ["low", "medium", "high"]
- pageReferences
  </action>
  <verify>
```bash
# Check files exist and have correct exports
bun -e "
import { ContractInfoSchema } from './services/contract/agents/schemas/contract-info';
import { BillingSchema } from './services/contract/agents/schemas/billing';
import { ContactsSchema } from './services/contract/agents/schemas/contacts';
import { ScheduleOfValuesSchema } from './services/contract/agents/schemas/sov';
import { InsuranceSchema } from './services/contract/agents/schemas/insurance';
import { SiteInfoSchema } from './services/contract/agents/schemas/site-info';
import { RedFlagsSchema } from './services/contract/agents/schemas/red-flags';
import type { AgentName, AgentResult } from './services/contract/agents/types';
console.log('All schemas and types import successfully');
"
```
  </verify>
  <done>All 7 Zod schemas exist with proper field definitions and .describe() annotations. Types file exports AgentName and AgentResult.</done>
</task>

<task type="auto">
  <name>Task 2: Create storage layer for agent results</name>
  <files>
    lib/db/index.ts
    services/contract/agents/storage.ts
  </files>
  <action>
Add the contract_extractions table to lib/db/index.ts and create storage functions.

**lib/db/index.ts additions:**
Add after the contract_pages table block:

```typescript
// ============================================
// Contract Extractions (Agent Results)
// ============================================
db.run(`
  CREATE TABLE IF NOT EXISTS contract_extractions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    contract_id INTEGER NOT NULL,
    agent_name TEXT NOT NULL,
    data TEXT NOT NULL,
    status TEXT NOT NULL DEFAULT 'success',
    error_message TEXT,
    duration_ms INTEGER NOT NULL,
    extracted_at TEXT NOT NULL DEFAULT (datetime('now')),
    FOREIGN KEY (contract_id) REFERENCES processed_contracts(id) ON DELETE CASCADE,
    UNIQUE(contract_id, agent_name)
  )
`);

db.run(
  "CREATE INDEX IF NOT EXISTS idx_contract_extractions_contract ON contract_extractions(contract_id)"
);
```

**services/contract/agents/storage.ts:**
- Import db from "@/lib/db"
- Import AgentName from "./types"
- storeAgentResult(contractId: number, agentName: AgentName, data: unknown, status: "success" | "error", errorMessage: string | null, durationMs: number): void
  - Use INSERT OR REPLACE to handle re-extraction
  - JSON.stringify the data before storing
- getAgentResults(contractId: number): Array<{ agentName: AgentName, data: unknown, status: string, errorMessage: string | null, durationMs: number }>
  - Query all results for a contract, JSON.parse the data field
  - Order by agent_name for consistent output
- getAllExtractedData(contractId: number): Record<AgentName, unknown> | null
  - Convenience function that returns all successful extractions as a keyed object
  - Returns null if no extractions exist
  </action>
  <verify>
```bash
# Check table exists and storage functions work
bun -e "
import { db } from './lib/db';
import { storeAgentResult, getAgentResults } from './services/contract/agents/storage';

// Verify table exists
const tables = db.query('SELECT name FROM sqlite_master WHERE type=\"table\" AND name=\"contract_extractions\"').all();
console.log('Table exists:', tables.length > 0);

// Verify functions are exported
console.log('storeAgentResult is function:', typeof storeAgentResult === 'function');
console.log('getAgentResults is function:', typeof getAgentResults === 'function');
"
```
  </verify>
  <done>contract_extractions table exists in SQLite. storeAgentResult and getAgentResults functions work correctly.</done>
</task>

<task type="auto">
  <name>Task 3: Create Mistral client helper for extraction</name>
  <files>services/contract/agents/mistral-client.ts</files>
  <action>
Create a reusable Mistral client factory configured for extraction.

**services/contract/agents/mistral-client.ts:**
```typescript
import { Mistral } from "@mistralai/mistralai";

/**
 * Create a Mistral client configured for extraction.
 * Throws if MISTRAL_API_KEY is not set.
 */
export function createMistralClient(): Mistral {
  const apiKey = process.env.MISTRAL_API_KEY;
  if (!apiKey) {
    throw new Error("MISTRAL_API_KEY environment variable is required for extraction");
  }
  return new Mistral({ apiKey });
}

/**
 * Default model for extraction tasks.
 * mistral-large-latest provides best accuracy for structured extraction.
 */
export const EXTRACTION_MODEL = "mistral-large-latest";

/**
 * Standard extraction settings.
 * - temperature: 0 for deterministic extraction
 * - maxTokens: 2048 for complex schemas (SOV line items can be large)
 */
export const EXTRACTION_SETTINGS = {
  temperature: 0,
  maxTokens: 2048,
} as const;
```

Why not mistral-small or ministral: Research indicates mistral-large-latest has best accuracy for structured extraction. Can benchmark later if cost is a concern.
  </action>
  <verify>
```bash
# Check export works (will fail if MISTRAL_API_KEY not set, but that's expected)
bun -e "
import { createMistralClient, EXTRACTION_MODEL, EXTRACTION_SETTINGS } from './services/contract/agents/mistral-client';
console.log('EXTRACTION_MODEL:', EXTRACTION_MODEL);
console.log('EXTRACTION_SETTINGS:', EXTRACTION_SETTINGS);
console.log('createMistralClient is function:', typeof createMistralClient === 'function');
"
```
  </verify>
  <done>Mistral client factory exports correctly. EXTRACTION_MODEL is "mistral-large-latest". EXTRACTION_SETTINGS has temperature: 0.</done>
</task>

</tasks>

<verification>
All foundation elements in place:
- [ ] 7 Zod schemas import without errors
- [ ] Each schema has pageReferences field
- [ ] contract_extractions table exists in SQLite
- [ ] storeAgentResult and getAgentResults work
- [ ] createMistralClient factory exists
- [ ] No lint errors: `bun x ultracite check`
</verification>

<success_criteria>
- All imports work: schemas, types, storage, mistral-client
- Table created: SELECT * FROM contract_extractions returns empty (not error)
- No TypeScript errors in new files
- No Biome lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-multi-agent-extraction/03-01-SUMMARY.md`
</output>
