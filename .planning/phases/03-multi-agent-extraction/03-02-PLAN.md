---
phase: 03-multi-agent-extraction
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - services/contract/agents/extractors/contract-info.ts
  - services/contract/agents/extractors/billing.ts
  - services/contract/agents/extractors/contacts.ts
  - services/contract/agents/extractors/sov.ts
  - services/contract/agents/extractors/insurance.ts
  - services/contract/agents/extractors/site-info.ts
  - services/contract/agents/extractors/red-flags.ts
autonomous: true

must_haves:
  truths:
    - "Each extractor calls Mistral with its Zod schema and returns validated data"
    - "All extractors use temperature 0 for deterministic extraction"
    - "System prompts instruct LLM to cite page numbers for each extraction"
  artifacts:
    - path: "services/contract/agents/extractors/contract-info.ts"
      provides: "extractContractInfo function"
      exports: ["extractContractInfo"]
    - path: "services/contract/agents/extractors/billing.ts"
      provides: "extractBilling function"
      exports: ["extractBilling"]
    - path: "services/contract/agents/extractors/contacts.ts"
      provides: "extractContacts function"
      exports: ["extractContacts"]
    - path: "services/contract/agents/extractors/sov.ts"
      provides: "extractSOV function"
      exports: ["extractSOV"]
    - path: "services/contract/agents/extractors/insurance.ts"
      provides: "extractInsurance function"
      exports: ["extractInsurance"]
    - path: "services/contract/agents/extractors/site-info.ts"
      provides: "extractSiteInfo function"
      exports: ["extractSiteInfo"]
    - path: "services/contract/agents/extractors/red-flags.ts"
      provides: "extractRedFlags function"
      exports: ["extractRedFlags"]
  key_links:
    - from: "services/contract/agents/extractors/*.ts"
      to: "services/contract/agents/schemas/*.ts"
      via: "schema import for responseFormat"
      pattern: "import.*Schema.*from.*schemas"
    - from: "services/contract/agents/extractors/*.ts"
      to: "@mistralai/mistralai"
      via: "chat.parse call"
      pattern: "mistral\\.chat\\.parse"
---

<objective>
Implement all 7 extraction agents that call Mistral with Zod schemas to extract structured contract data with page citations.

Purpose: Create specialized extractors for each contract data domain (EXTR-01 through EXTR-07)
Output: 7 extractor functions ready for parallel orchestration
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-multi-agent-extraction/03-RESEARCH.md
@.planning/phases/03-multi-agent-extraction/03-01-SUMMARY.md
@services/contract/agents/types.ts
@services/contract/agents/schemas/contract-info.ts
@services/contract/agents/mistral-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Contract Info, Billing, and Contacts extractors</name>
  <files>
    services/contract/agents/extractors/contract-info.ts
    services/contract/agents/extractors/billing.ts
    services/contract/agents/extractors/contacts.ts
  </files>
  <action>
Create the first 3 extractors following the pattern from RESEARCH.md.

**Each extractor file structure:**
1. Import Mistral type, schema, inferred type, and EXTRACTION_MODEL/EXTRACTION_SETTINGS
2. Define a domain-specific SYSTEM_PROMPT constant
3. Export async function that takes (fullText: string, mistral: Mistral) and returns the inferred type
4. Use mistral.chat.parse() with responseFormat: Schema
5. Double-validate with schema.safeParse() for belt-and-suspenders
6. Throw descriptive error if validation fails

**contract-info.ts (EXTR-01):**
```typescript
import type { Mistral } from "@mistralai/mistralai";
import { ContractInfoSchema, type ContractInfo } from "../schemas/contract-info";
import { EXTRACTION_MODEL, EXTRACTION_SETTINGS } from "../mistral-client";

const SYSTEM_PROMPT = `You are a contract analysis expert. Extract contract identification information from the provided document.

IMPORTANT INSTRUCTIONS:
1. Only extract information explicitly stated in the document
2. Use null for any field where information is not found
3. For pageReferences, cite the page number(s) where you found the information
4. Pages are separated by "---PAGE BREAK---" markers. Page 1 is before the first marker.
5. Do not invent or assume information not present in the document
6. For contractType, classify based on document title and content:
   - LOI = Letter of Intent
   - Subcontract = Full subcontract agreement
   - Work Order = Task order or work authorization
   - Amendment = Change order or contract modification
   - Unknown = Cannot determine from document`;

export async function extractContractInfo(
  fullText: string,
  mistral: Mistral
): Promise<ContractInfo> {
  const response = await mistral.chat.parse({
    model: EXTRACTION_MODEL,
    messages: [
      { role: "system", content: SYSTEM_PROMPT },
      { role: "user", content: fullText },
    ],
    responseFormat: ContractInfoSchema,
    ...EXTRACTION_SETTINGS,
  });

  const parsed = ContractInfoSchema.safeParse(response.choices[0].message.parsed);
  if (!parsed.success) {
    throw new Error(`Contract info extraction validation failed: ${parsed.error.message}`);
  }

  return parsed.data;
}
```

**billing.ts (EXTR-02):**
System prompt should emphasize:
- Retention is typically stated as percentage (5%, 10%)
- Billing platforms: Textura, Procore, GCPay, Premier common in construction
- Certified payroll requirements often in federal/state funded projects
- Look for payment terms, invoice submission deadlines

**contacts.ts (EXTR-03):**
System prompt should emphasize:
- PM = Project Manager, may be listed as "Owner's Rep" or "Construction Manager"
- Superintendent may be "Site Super", "Field Engineer", or similar
- Extract direct contact info (phone, email) not just names
- May be in signature blocks or contact sections
  </action>
  <verify>
```bash
bun -e "
import { extractContractInfo } from './services/contract/agents/extractors/contract-info';
import { extractBilling } from './services/contract/agents/extractors/billing';
import { extractContacts } from './services/contract/agents/extractors/contacts';
console.log('extractContractInfo is function:', typeof extractContractInfo === 'function');
console.log('extractBilling is function:', typeof extractBilling === 'function');
console.log('extractContacts is function:', typeof extractContacts === 'function');
"
```
  </verify>
  <done>Contract Info, Billing, and Contacts extractors export async functions that take (fullText, mistral) and return validated schema types.</done>
</task>

<task type="auto">
  <name>Task 2: Implement SOV, Insurance, Site Info, and Red Flags extractors</name>
  <files>
    services/contract/agents/extractors/sov.ts
    services/contract/agents/extractors/insurance.ts
    services/contract/agents/extractors/site-info.ts
    services/contract/agents/extractors/red-flags.ts
  </files>
  <action>
Create the remaining 4 extractors.

**sov.ts (EXTR-04):**
System prompt should emphasize:
- SOV = Schedule of Values, lists work items with prices
- May be called "Bid Schedule", "Cost Breakdown", "Payment Schedule"
- Extract line items exactly as written (itemNumber, description, amount)
- Amount may be missing if SOV is placeholder/TBD
- scopeSummary captures high-level scope descriptions

**insurance.ts (EXTR-05):**
System prompt should emphasize:
- GL = General Liability, look for "per occurrence" and "aggregate" limits
- Umbrella/Excess provides additional coverage above GL
- Workers Comp may state "statutory" instead of dollar amount
- Additional Insured means contractor adds GC to their policy
- Waiver of Subrogation prevents insurer from suing other parties
- Primary & Non-Contributory means contractor's policy pays first

**site-info.ts (EXTR-06):**
System prompt should emphasize:
- Site address may differ from mailing/billing address
- Site hours = working hours allowed on site
- Access instructions include gate codes, check-in procedures
- Safety requirements include PPE, certifications, orientations

**red-flags.ts (EXTR-07):**
System prompt should emphasize:
- Unusual terms: liquidated damages, indemnification clauses, warranty extensions
- Maintenance language: obligations beyond construction (extended warranties, maintenance periods)
- T&M language: Time & Materials provisions (can be unlimited cost exposure)
- Vague language: "as directed", "to owner's satisfaction", undefined scope
- Missing info: no start date, no payment terms, missing insurance requirements
- Risk levels:
  - low: Standard terms, no concerns
  - medium: Some unusual terms or vague language
  - high: Multiple concerning terms or missing critical info

Same structure as Task 1: import schema, define SYSTEM_PROMPT, export async extraction function.
  </action>
  <verify>
```bash
bun -e "
import { extractSOV } from './services/contract/agents/extractors/sov';
import { extractInsurance } from './services/contract/agents/extractors/insurance';
import { extractSiteInfo } from './services/contract/agents/extractors/site-info';
import { extractRedFlags } from './services/contract/agents/extractors/red-flags';
console.log('extractSOV is function:', typeof extractSOV === 'function');
console.log('extractInsurance is function:', typeof extractInsurance === 'function');
console.log('extractSiteInfo is function:', typeof extractSiteInfo === 'function');
console.log('extractRedFlags is function:', typeof extractRedFlags === 'function');
"
```
  </verify>
  <done>SOV, Insurance, Site Info, and Red Flags extractors export async functions. All 7 extractors are ready for orchestration.</done>
</task>

</tasks>

<verification>
All 7 extractors implemented:
- [ ] All 7 extractor functions import without errors
- [ ] Each uses mistral.chat.parse with responseFormat
- [ ] Each has domain-specific SYSTEM_PROMPT
- [ ] Each uses EXTRACTION_MODEL and EXTRACTION_SETTINGS
- [ ] Each does safeParse validation after API call
- [ ] No lint errors: `bun x ultracite check`
</verification>

<success_criteria>
- All 7 extractors can be imported
- Each function signature: (fullText: string, mistral: Mistral) => Promise<SchemaType>
- System prompts include page citation instructions
- No TypeScript or lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-multi-agent-extraction/03-02-SUMMARY.md`
</output>
